# 트랜잭션(Transaction)

- [트랜잭션이란?](#트랜잭션이란)
- [트랜잭션의 특성 ACID](#트랜잭션의-특성-acid)
    - [지속성(Durability)를 지키는 방법](#지속성durability를-지키는-방법)
- [트랜잭션의 상태](#트랜잭션의-상태)
    - [Partially Committed와 Committed의 차이점](#partially-committed와-committed의-차이점)
- [트랜잭션 격리레벨](#트랜잭션-격리레벨)
- [데드락](#데드락deadlock)
    - [데드락의 빈도를 낮추는 방법](#데드락의-빈도를-낮추는-방법)
- [Question](#question)

---

## 트랜잭션이란?
트랜잭션이란 **데이터의 완전성** 을 보장해주기 위해서 논리적인 작업 셋을 모두 완벽하게 처리하거나 또는 처리하지 못할 경우 일부만 적용되는 현상이 발생하지 않기 위해서 사용한다. **데이터베이스의 상태를 변화시키기위해 수행하는 작업의 단위라고 할 수 있다.**

> 상태를 변화시킨다는 것은 SQL 쿼리를 이용해서 DB에 접근하는 것을 의미한다.

하나의 트랜잭션은 Commit되거나 Rollback된다.
- Commit
    - 한개의 논리적인 단위(트랜잭션)에 대한 작업이 성공적으로 끝나고 데이터베이스가 일관된 상태에 있을 때, 트랜잭션이 수행한 갱신연산이 완료되었다는 것을 트랜잭션 관리자에게 알려주는 것.
- Rollback
    - 하나의 트랜잭션 처리가 비정상적으로 종료되어서 데이터베이스의 일관성을 깨뜨렸을 때, 이 트랜잭션의 일부가 정상적으로 처리되었더라도 트랜잭션의 원자성을 구현하기 위해 이 **트랜잭션이 행한 모든 연산을 취소하는 연산** 이다.
    - Rollback시에는 해당 트랜잭션을 재시작하거나 폐기한다.

## 트랜잭션의 특성 ACID
트랜잭션의 특징으로는 `원자성(Atomicity)`, `지속성(Consistency)`, `독립성(Isolation)`, `지속성(Durablilty)`이 있다.
- 원자성
    - 트랜잭션의 모든연산들은 정상적으로 수행완료되거나 아니면 어떠한 연산도 수행되지 않은 상태를 보장해야한다.
- 지속성
    - 트랜잭션이 완료 후에도 데이터베이스가 일관된상태로 유지되어야 한다.
- 독립성
    - 트랜잭션 완료 후에도 데이터베이스가 일관된 상태로 유지되어야한다.
- 지속성
    - 성공적으로 수행된 트랜잭션은 영원히 반영되어야 한다.

### 지속성(Durability)를 지키는 방법
트랜잭션의 지속성을 관리하기 위해서 DBMS가 데이터베이스 객체의 갱신작업에 대한 기록인 로그를 관리합니다. 커밋된 트랜잭션에 의해 갱신된 내용이 디스크에 반영되기 전에 시스템장애가 발생하면, 시스템 재구동시에 로그를 판독해서 변경된 내용을 복구하게 됩니다. 

## 트랜잭션의 상태
<img width="80%" src="https://user-images.githubusercontent.com/76734067/214269085-481f1857-28ba-4ed9-9cd6-e30df4c848ad.png">

- **Active** : 트랜잭션의 활동상태. 트랜잭션이 실행중이며 동작중이 상태를 말한다.
- **Failed** : 트랜잭션 실패상태. 트랜잭션이 더이상 정상적으로 진행될 수 없는 상태를 말한다.
- **Partially Committed** : 트랜잭션의 commit명령이 도착한 상태. 트랜잭션의 commit이전 sql문이 수행되고 commit만 남은 상태를 말한다.
- **Committed** : 트랜잭션 완료상태. 트랜잭션이 정상적으로 완료된 상태를 말한다.
- **Aborted** : 트랜잭션 취소상태. 트랜잭션이 취소되고 트랜잭션 실행 이전 데이터로 돌아간 상태를 말한다.

### Partially Committed와 Committed의 차이점
`Commit`요청이 들어오면 상태는 `Partial Commited`상태가 된다. 이후 `Commit`을 문제없이 수행할 수 있으면 `Committed`상태로 전이되고, 만약 오류가 발생하면 Failed상태가 된다. 즉, **`Partial Committed`는 Commit요청이 들어왔을 때를 말하며, `ommitted`는 `Commit`을 정상적으로 완료한 상태를 말한다.** 

## 트랜잭션 격리레벨
트랜잭션의 격리 레벨은 동시에 여러 트랜잭션이 처리될 때 트랜잭션끼리 얼마나 서로 고립되어있는지를 나타내는 것입니다. 어떤 **트랜잭션이 다른 트랜잭션이 변경한 결과를 볼 수 있도록 허용할지 말지를 결정하는 것입니다.**

격리 수준은 크게 `READ UNCOMMITTED`, `READ COMMITED`, `REPEATABLE READ`, `SERIALIZABLE`가 있습니다.

- `READ UNCOMMITTED`
    - 어떤 트랜잭션의 변경내용이 COMMIT이나 ROLLBACK과 상관없이 다른 트랜잭션에 보여집니다.
- `READ COMMITTED`
    - 어떤 트랜잭션의 변경내용이 COMMIT되어야만 다른 트랜잭션에서 조회할 수 있습니다. 온라인서비스에서 가장 많이 선택되는 격리수준입니다. 
    - 데이터가 중간에 바뀌고 커밋된 다음에 트랜잭션 내에서 똑같은 SELECT를 수행했을 경우 항상 같은 결과를 반환해야한다는 REPEATABLE READ 정합성에 어긋나게 됩니다. 따라서 격리수준에 의해 실행되는 SQL문장이 어떤 결과를 출력할 지 정확히 예측하고 있어야 합니다.
- `REPEATABLE READ`
    - 트랜잭션이 시작되기 전에 커밋한 내용에 대해서만 조회할 수 있는 격리레벨이다.
    - 자신의 트랜잭션 번호보다 낮은 트랜잭션 번호에서 변경된 것만 보게 되는 것입니다.
- `SERIALIZABLE`
    - 가장 단순하고 엄격한 격리수준이다.
    - 한 트랜잭션에서 읽고 쓰는 레코드를 다른 트랜잭션에서는 절대 접근할 수 없습니다.

### 격리수준에 따라 발생할 수 있는 문제점
- **`DIRTY READ`** : 어떠한 트랜잭션에서 처리한 작업이 완료되지 않았음에도 불구하고 다른 트랜잭션에서 볼 수 있게되는 현상
- **`NON-REPEATABLE READ`** : 동일한 SELECT 쿼리를 실행했을 때 항상 같은 결과를 보장해야한다는 REPEATABLE READ정합성에 어긋나는 현상
- **`PHANTOM READ`** : 한 트랜잭션 내에서 동일한 쿼리를 두번 수행했는데 첫 번째 쿼리에서 존재하지 않던 유령(Phantom)레코드가 두 번째 쿼리에서 나타나는 현상

## 데드락(DeadLock)
여러개의 트랜잭션을 사용하다보면 데드락이 일어날 수 있다. 데드락이란 두개 이상의 트랜잭션이 특정자원의 잠금을 획득한 채 다른 트랜잭션이 소유하고 있는 잠금을 요구하면 아무리 기다려도 상황이 바뀌지 않는 상태가 되는데 이를 데드락이라고 한다.

### 데드락의 빈도를 낮추는 방법
- 트랜잭션을 자주 커밋한다.
- 정해진 순서로 테이블에 접근한다. 트랜잭션들이 동일한 테이블 순으로 접근하게 한다.
- 읽기 잠금 획득(SELECT ~ FOR UPDATE)의 사용을 피한다.
- 테이블단위의 잠금을 획득해서 갱신을 직렬화하면 동시성을 떨어지지만 교착상태를 피할 수 잇따.

# Question
> **트랜잭션이 무엇인가요?**<br>
> 트랜잭션이란 데이터베이스의 상태를 변화시키기 위해 수행하는 작업의 한 단위입니다.

> **ACID원칙에 대해서 설명해주세요**<br>
> ACID원칙이란 트랜잭션이 가져야하는 특성을 말합니다. 원자성, 일관성, 독립성, 지속성이라는 네가지 특성을 말합니다. 먼저 원자성은 트랜잭션이 완전히 수행되거나 수행되지 않거나 하는 것을 보장해야한다는 것이고, 일관성은 트랜잭션이 수행된 후에도 데이터베이스의 일관성을 유지되어야한다. 그리고 독립성은 서로다른 트랜잭션이 영향을 끼치지 않아야한다는 것이고, 지속성은 트랜잭션의 갱신 내용이 데이터베이스에 영구적으로 반영되어야 한다는 특성입니다.

> **그렇다면 DBMS는 어떤방법으로 지속성을 유지하나요?**<br>
> DBMS는 커밋이나 롤백이 일어날때마다 갱신작업에 대한 기록인 로그(log)를 활용합니다. 커밋된 트랜잭션에 의해 데이터가 반영되기 이전에 시스템에 장애가 발생하면 시스템을 재구동시킬때 로그에 있는 내용을 보고 복구르 ㄹ진행합니다.

> **트랜잭션 격리레벨에 대해 설명해주세요**<br>
> 트랜잭션의 격리레벨이란 각각의 트랜잭션들이 독립되어있는 정도라고 볼 수 있습니다. 어떤 트랜잭션이 다른트랜잭션이 수정한 내용을 조회할 수 있는가를 나타냅니다. <br>
> 트랜잭션 레벨에는 READ UNCOMMITTED, READ COMMITTED, READ REPEATABLE, SILIALIZABLE이 있습니다.



